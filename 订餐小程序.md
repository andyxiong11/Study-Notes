# 订餐小程序

# 1. Centos环境

## 1.1 安装MySQL

1. 卸载默认安装mariadb数据库

   ```shell
   yum remove mariadb-libs.x86_64
   ```

2. 安装源

   ```shell
   yum localinstall mysql57-community-release-el7-8.noarch.rpm
   ```

3. 安装MySQL

   ```shell
   yum install mysql-community-server
   ```

4. 启动

   ```shell
   service mysqld start/restart
   service mysqld stop
   ```

4. 查看默认密码

   ```shell
   cat /var/log/mysqld.log | grep "password"
   ```

6. 登录

   ```shell
   mysql -uroot -p
   ```

## 1.2 安装python3.7

```shell
1. yum install openssl-devel bzip2-devel expat-devel gdbm-devel readline-devel sqlite-devel
2. wget "https://www.python.org/ftp/python/3.7.0/Python-3.7.0.tgz"
3. tar -zxvf Python-3.7.0.tgz
4. mkdir /usr/local/python3
5. Python-3.7.0/configure --prefix=/usr/local/python3//报错，需安装gcc
6. make //tmp目录执行
7. make install
8. ln -s /usr/local/python3/bin/python3 /usr/bin/python3//添加软连接，便于直接执行python3
<!--测试
cd /tmp
vi test.py
python test.py-->
```

## 1.3 安装pip3和virtualenv

```shell
1. ln -s /usr/local/python3/bin/pip3 /usr/bin/pip3
2. pip3 install virtualenv
3. ln -s /usr/local/python3/bin/virtualenv /usr/bin/virtualenv
4. virtualenv -p /usr/bin/python3
<!--测试
~   cd imooc_env
source bin/activate
which python
python-->
5.deactivate//退出
```

## 1.4 虚拟机共享主机目录

```shell
/mnt/hgfs/
```

# 2.Windows环境

## mysql和python3.7安装

# 3.Flask框架入门

> 轻量级框架，比Django更适合开发小项目

## 3.1 Centos安装Flask

```shell
1.pip3 insatll flask
<!--测试
python3
import flask-->
2.source imooc_env/bin/activate//进入虚拟环境安装，虚拟环境只需使用python，python3已经复制过来了
3.pip3 install flask
```

## 3.2 Windows安装Flask

1. 下载pip

1. 管理员命令行

   ```shell
   e:
   cd E:\Downloads\pip-21.0.1
   ```

1. 安装pip

   ```shell
   python setup.py install 
   <!--测试
   pip-->
   ```

4. 安装flask

   ```shell
   pip install flask//大概率网络问题安装失败
   <!--解决办法
   在当前用户目录下新建pip文件夹
   新建文件pip.ini
   [global]
   index-url = http://pypi.douban.com/simple
   trusted-host = pypi.douban.com
   -->
   ```

## 3.3 Flask HelloWorld

```python
from flask import Flask//引入Flask类

app = Flask(__name__)//初始化app Flask类传递的参数__name__方法

@app.route('/')//"/"作为网址
def hello_world()://hell__world方法
    return 'Hello World'

if __name__ == "__main__":
    app.run()
```

**关闭Centos防火墙**

```shell
service firewalld stop/disable//关闭或禁用
```

* 让服务器运行程序，物理机也能通过http://127.0.0.1:5000/访问。
* 但是这时候物理机还是无法访问，需要修改调用flask官方的run()方法

```python
app.run(host='0.0.0.0')
```

* 物理机访问需要访问服务器ip http://192.168.200.133:5000/

## 3.4 路由规划

```python
from flask import Flask

app = Flask(__name__)

@app.route('/')
def hello_world():
    return 'Hello World'

@app.route('/api')
def index():
    return 'Index page'

@app.route('/api/hello')
def hello():
    return 'Hello World'

if __name__ == "__main__":
    app.run(host='0.0.0.0')
```

* 第二种 蓝牙模块

  **HelloWorld.py**

```python
from flask import Flask
from imooc import route_imooc

app = Flask(__name__)
app.register_blueprint(route_imooc,url_prefix = "/imooc")//统一前缀

@app.route('/')
def hello_world():
    return 'Hello World'

@app.route('/api')
def index():
    return 'Index page'

@app.route('/api/hello')
def hello():
    return 'Hello World'

if __name__ == "__main__":
    app.run(host='0.0.0.0')
```

​	**imooc.py**

```python
from flask import Blueprint

route_imooc = Blueprint("imooc_page",__name__)

@route_imooc.route('/')
def index():
    return "imooc index page"

@route_imooc.route('/hello')
def hello():
    return "imooc hello world"
```

## 3.5 链接管理器和版本管理

**连接管理器 url_for**

* 统一管理链接

  **common>libs>UrlManager.py**

  ```python
  class UrlManager( object ):
      @staticmethod
      def buildUrl( path ):
              return path
  
      @staticmethod
      def buildStaticUrl( path ):
              return path
  ```

  **HelloWorld.py**

  ```python
  from flask import Flask,url_for
  from common.libs.UrlManager import UrlManager
  
  app = Flask(__name__)
  
  @app.route('/')
  def hello_world():
  
      url = url_for("index")
      
      url_1 = UrlManager.buildUrl("/api")
  
      return 'Hello World,url:%s,url_1:%s' %(url,url_1) //url:/api,url_1:/api
          
  @app.route('/api')
  def index():
      return 'Index page'
  
  if __name__ == "__main__":
      app.run(host='0.0.0.0')
  ```

**版本管理**

​	**common>libs>UrlManager.py**

```python
class UrlManager( object ):
    @staticmethod
    def buildUrl( path ):
        return path

    @staticmethod
    def buildStaticUrl( path ):
        path = path + "?ver=" + "202103160957" //假设版本号202103160957
        return UrlManager.buildUrl(path)
```

​	**HelloWorld.py**

```python
from flask import Flask,url_for
from common.libs.UrlManager import UrlManager

app = Flask(__name__)

@app.route('/')
def hello_world():

    url_2 = UrlManager.buildStaticUrl("/css/bootstrap.css")

    return 'url_2:%s' %(url_2) //url_2:/css/bootstrap.css?ver=202103160957

if __name__ == "__main__":
    app.run(host='0.0.0.0')
```

## 3.6 日志系统

* app.logger.debug('A value for debugging')
* app.logger.warning('A warning occurred (%d apples)',42)
* app.logger.error('An error occurred')
* 便于检测问题，执行了某个操作会报错

```python
from flask import Flask, url_for

app = Flask(__name__)

@app.route('/')
def hello_world():

    url = url_for("index")

    url_1 = UrlManager.buildUrl("/api")

    url_2 = UrlManager.buildStaticUrl("/css/bootstrap.css")

    msg = 'Hello World,url:%s,url_1:%s,url_2:%s' %(url,url_1,url_2)

    app.logger.error(msg)
    app.logger.info(msg)
    app.logger.debug(msg)

    return msg

@app.route('/api')
def index():
    return 'Index page'

if __name__ == "__main__":
    app.run(host='0.0.0.0')
```

**开启debug**

```python
app.run(host='0.0.0.0', debug = True)
```

## 3.7 错误处理

* flask.Blueprint.errorhandler
* flask.Flask.errorhandler
* flask.Blueprint.app_errohandler

**页面不存在时报错提示**

```python
@app.errorhandler(404)
def page_not_found(error):
    app.logger.error( error ) //输出错误日志
    return 'This page does not exist', 404
```

## 3.8 数据库ORM

### 3.8.1 windows环境

1. 以管理员身份运行pycharm

1. 在项目文件夹目录下运行 

   pip install flask-sqlalchemy

   pip install mysqlclient

   * 错误解决

     >下载对应的mysqlclient安装包：（地址：https://www.lfd.uci.edu/~gohlke/pythonlibs/#mysql-python）
     >
     >然后使用pip install mysqlclient 包名.whl

   ```python
   from flask import Flask
   from flask_sqlalchemy import SQLAlchemy
   
   app = Flask(__name__)
   
   app.config['SQLALCHEMY_DATABASE_URI'] = 'mysql://root:331133@127.0.0.1/mysql'
   db = SQLAlchemy(app)
   
   @app.route('/api/hello')
   def hello():
   
       from sqlalchemy import text
       sql = text("SELECT * FROM `user` ")
       result = db.engine.execute(sql)
       for row in result:
           app.logger.info(row)
   
       return 'Hello World'
   
   @app.errorhandler(404)
   def page_not_found(error):
       app.logger.error(error)
       return 'This page does not exist', 404
   
   if __name__ == "__main__":
       app.run(host='0.0.0.0', debug=True)
   ```

### 3.8.2 centos7环境

1. 重置数据库的root账号密码

   ```mysql
   1. source imooc_env/bin/activate
   2. cat /var/log/mysqld.log |grep 'password'
   3. mysql -uroot -p
   4. SET PASSWORD = PASSWORD('331133');
   //此时会提示密码过于简单，需要修改两个全局变量
   set global validate_password_policy=0;
   set global validate_password_length=1;
   5. ALTER USER 'root'@'localhost' PASSWORD EXPIRE NEVER;
   6. flush privileges;
   ```

2. 安装扩展

   ```shell
   1. pip install Flask-SQLAlchemy
   2. yum -y install mysql-devel gcc gcc-devel python-devel
   3. pip install mysqlclient
   ```


## 3.9 flask mvc框架结构

<img src="https://gitee.com/ye_xing_bear/pic-go/raw/master/%E4%B8%AA%E4%BA%BA%E5%9B%BE%E5%BA%8A/image-20210318152510086.png" alt="image-20210318152510086" style="zoom: 50%;" />





